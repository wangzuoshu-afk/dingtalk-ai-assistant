# 钉钉AI助手部署指南

本文档提供了钉钉AI助手的详细部署步骤，涵盖从钉钉机器人创建到云平台部署的完整流程。无论您选择Railway、Render还是其他云平台，都可以参考本指南完成部署。

## 一、前置准备

在开始部署之前，请确保您已经准备好以下账号和资源。这些账号的注册流程通常都很简单，大部分提供免费计划。

### 1.1 必需账号

**钉钉企业账号**：您需要一个钉钉企业账号，并拥有管理员权限。如果您还没有企业账号，可以在钉钉官网免费创建一个。企业账号是创建企业内部应用的前提，只有企业管理员才能访问开发者后台。

**OpenAI账号**：您需要注册OpenAI账号并获取API密钥。OpenAI提供了GPT系列模型和Whisper语音识别模型，这是本项目的核心AI能力来源。访问[OpenAI官网](https://platform.openai.com/)注册账号，然后在API Keys页面生成一个新的密钥。请妥善保管您的API密钥，不要泄露给他人。

**GitHub账号**：用于托管代码和连接云平台。大部分现代化的云平台都支持从GitHub仓库直接部署，这大大简化了部署流程。如果您还没有GitHub账号，可以在[GitHub官网](https://github.com/)免费注册。

**云平台账号**：您需要选择一个云平台来部署应用。我们推荐使用Railway或Render，它们都提供了慷慨的免费额度，并且部署流程非常简单。您可以使用GitHub账号直接登录这些平台，无需单独注册。

### 1.2 可选账号

**NewsAPI账号**：如果您希望使用真实的新闻数据源，可以注册[NewsAPI](https://newsapi.org/)账号。NewsAPI提供免费开发者计划，每天可以请求100次。如果不配置NewsAPI密钥，系统会使用内置的模拟数据进行演示。

## 二、创建钉钉企业内部应用

钉钉企业内部应用是本项目的基础，它提供了机器人与用户交互的能力。以下是详细的创建步骤。

### 2.1 登录开发者后台

访问[钉钉开放平台](https://open-dev.dingtalk.com/)，使用您的钉钉账号登录。登录后，您会看到开发者后台的主界面，这里可以管理您的所有应用。

### 2.2 创建应用

在开发者后台首页，点击"应用开发"菜单，然后选择"企业内部开发"。点击右上角的"创建应用"按钮，填写以下信息：

- **应用名称**：例如"AI小助手"或"智能机器人"，这个名称会显示在钉钉客户端中。
- **应用描述**：简要描述应用的功能，例如"基于OpenAI的智能AI助手，支持问答、资讯推送和报告生成"。
- **应用图标**：上传一个代表您应用的图标，建议使用正方形图片，尺寸为512x512像素。

填写完成后，点击"确认创建"按钮。系统会为您的应用分配一个唯一的AppKey和AppSecret，这两个值将在后续配置中使用。

### 2.3 添加机器人能力

创建应用后，您会进入应用详情页面。在左侧菜单中找到"应用能力"，点击"添加应用能力"按钮，在弹出的列表中选择"机器人"，然后点击"添加"。

添加机器人能力后，您需要配置机器人的基本信息：

- **机器人名称**：例如"AI小助手"，这个名称会在对话中显示。
- **机器人描述**：简要描述机器人的功能。
- **机器人头像**：上传一个头像图片。

### 2.4 配置消息接收

在机器人配置页面，找到"消息接收模式"选项，选择"HTTP推送"。这意味着当用户向机器人发送消息时，钉钉服务器会通过HTTP POST请求将消息推送到您指定的服务器地址。

在"消息接收地址"输入框中，暂时留空。我们会在部署应用后获得一个公网URL，然后再回来填写这个地址。

### 2.5 配置权限

在应用详情页面，找到"权限管理"菜单。搜索并添加以下权限：

- **机器人发送消息**：允许机器人主动向用户或群聊发送消息。
- **机器人接收消息**：允许机器人接收用户发送的消息。
- **文件管理读权限**（可选）：如果需要处理用户上传的文件，需要添加此权限。

### 2.6 发布应用

完成所有配置后，在"版本管理与发布"页面点击"发布"按钮。发布后，您的应用就可以在企业内部使用了。

### 2.7 获取AppKey和AppSecret

在应用详情页面的"基础信息"部分，您可以找到**AppKey**和**AppSecret**。请妥善保管这两个值，它们将用于后续的环境变量配置。AppSecret是敏感信息，不要泄露给他人。

## 三、部署应用到Railway

Railway是一个现代化的云平台，提供了极简的部署体验和慷慨的免费额度。以下是详细的部署步骤。

### 3.1 Fork项目

访问本项目的GitHub仓库，点击右上角的"Fork"按钮，将项目Fork到您自己的GitHub账号下。这样您就可以自由修改代码，并且可以随时从原仓库拉取更新。

### 3.2 登录Railway

访问[Railway官网](https://railway.app/)，点击"Login"按钮，选择"Login with GitHub"。Railway会请求访问您的GitHub账号，授权后即可登录。

### 3.3 创建新项目

登录Railway后，点击"New Project"按钮，然后选择"Deploy from GitHub repo"。在弹出的列表中，找到您刚刚Fork的`dingtalk-ai-assistant`仓库，点击选择。

Railway会自动检测到项目中的`requirements.txt`文件，并开始安装Python依赖。这个过程可能需要几分钟时间。

### 3.4 配置环境变量

在项目部署完成后，点击项目卡片进入项目详情页面。在顶部菜单中找到"Variables"选项卡，点击进入环境变量配置页面。

点击"New Variable"按钮，逐个添加以下环境变量：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `OPENAI_API_KEY` | OpenAI API密钥 | `sk-proj-xxxxx` |
| `DINGTALK_APP_KEY` | 钉钉应用AppKey | `dingxxxxxxx` |
| `DINGTALK_APP_SECRET` | 钉钉应用AppSecret | `xxxxxxxxxxxxxxxx` |
| `DINGTALK_WEBHOOK_URL` | 钉钉Webhook地址（可选） | `https://oapi.dingtalk.com/robot/send?access_token=xxxxx` |
| `NEWS_API_KEY` | NewsAPI密钥（可选） | `xxxxxxxxxxxxxxxx` |
| `SECRET_KEY` | Flask Session密钥 | `a_random_secret_key_12345` |
| `TIMEZONE` | 时区 | `Asia/Shanghai` |
| `DAILY_NEWS_TIME` | 每日推送时间 | `09:00` |

添加完所有环境变量后，Railway会自动重新部署应用。您可以在"Deployments"选项卡中查看部署进度。

### 3.5 获取公网URL

部署成功后，在项目详情页面的"Settings"选项卡中，找到"Domains"部分。点击"Generate Domain"按钮，Railway会为您生成一个公网域名，例如`https://dingtalk-ai-assistant-production.up.railway.app`。

复制这个URL，我们将在下一步中使用它。

### 3.6 配置钉钉回调地址

回到钉钉开发者后台，找到您创建的应用，进入机器人配置页面。在"消息接收地址"输入框中，填入Railway提供的公网URL，并在末尾加上`/webhook`路径。例如：

```
https://dingtalk-ai-assistant-production.up.railway.app/webhook
```

保存配置后，点击"重新发布"按钮。钉钉会向您的服务器发送一个验证请求，如果配置正确，验证会自动通过。

## 四、部署应用到Render（备选方案）

如果您选择使用Render平台，部署流程与Railway类似，但有一些细微差别。

### 4.1 登录Render

访问[Render官网](https://render.com/)，使用GitHub账号登录。

### 4.2 创建Web Service

在Render控制台，点击"New +"按钮，选择"Web Service"。连接您的GitHub账号，选择`dingtalk-ai-assistant`仓库。

### 4.3 配置服务

在配置页面，填写以下信息：

- **Name**：服务名称，例如`dingtalk-ai-assistant`。
- **Region**：选择离您最近的区域，例如`Singapore`。
- **Branch**：选择`main`或`master`分支。
- **Build Command**：`pip install -r requirements.txt`
- **Start Command**：`gunicorn app.app:app`

### 4.4 添加环境变量

在"Environment"部分，点击"Add Environment Variable"按钮，添加与Railway相同的环境变量。

### 4.5 部署

点击"Create Web Service"按钮，Render会开始构建和部署您的应用。部署完成后，Render会提供一个公网URL，您可以使用这个URL配置钉钉回调地址。

## 五、测试机器人

### 5.1 添加机器人到群聊

在钉钉客户端中，创建一个测试群聊。进入群设置，点击"智能群助手" -> "添加机器人"，在列表中找到您创建的AI助手，点击添加。

### 5.2 测试文字对话

在群聊中，@您的机器人，发送一条消息，例如"你好"。如果配置正确，机器人会在几秒钟内回复您。

### 5.3 测试报告生成

发送一条包含"报告"关键词的消息，例如"生成一份关于GPT-4的详细报告"。机器人会开始生成报告，并在完成后回复您。

### 5.4 测试语音消息

与机器人进行单聊，发送一条语音消息。如果您已经配置了`DINGTALK_APP_KEY`和`DINGTALK_APP_SECRET`，机器人会自动识别语音内容并回复。

### 5.5 测试定时推送

等待到设定的推送时间（默认是每天早上9点），机器人会自动向群聊推送最新的AI资讯。您也可以修改`DAILY_NEWS_TIME`环境变量来调整推送时间。

## 六、常见问题

### 6.1 机器人没有回复

**可能原因**：
- 回调地址配置错误：检查钉钉后台的消息接收地址是否正确，确保末尾有`/webhook`路径。
- 环境变量未配置：检查Railway或Render的环境变量是否正确配置，特别是`OPENAI_API_KEY`和`DINGTALK_APP_SECRET`。
- 服务未启动：检查云平台的部署日志，确认服务是否成功启动。

**解决方法**：
- 访问`https://your-domain.com/health`检查服务是否正常运行。
- 查看云平台的日志，寻找错误信息。

### 6.2 语音消息无法识别

**可能原因**：
- 未配置`DINGTALK_APP_KEY`和`DINGTALK_APP_SECRET`。
- 在群聊中发送语音消息（钉钉限制，群聊中机器人无法接收语音）。

**解决方法**：
- 确保环境变量中已配置`DINGTALK_APP_KEY`和`DINGTALK_APP_SECRET`。
- 与机器人进行单聊，而不是在群聊中发送语音消息。

### 6.3 定时推送不工作

**可能原因**：
- 未配置`DINGTALK_WEBHOOK_URL`。
- 时区设置错误。

**解决方法**：
- 在钉钉群中添加一个自定义机器人，获取Webhook地址，并配置到环境变量中。
- 确保`TIMEZONE`环境变量设置为`Asia/Shanghai`或您所在的时区。

### 6.4 PDF报告无法生成

**可能原因**：
- 缺少中文字体。
- 服务器磁盘空间不足。

**解决方法**：
- 检查服务器是否安装了中文字体，如果没有，可以通过SSH连接服务器并安装。
- 检查磁盘空间，清理不必要的文件。

## 七、进阶配置

### 7.1 自定义系统提示词

您可以在`config/config.py`文件中修改`SYSTEM_PROMPT`变量，自定义AI助手的行为和风格。例如，您可以让它更专注于某个特定领域，或者使用更幽默的语气。

### 7.2 添加更多消息类型

在`utils/dingtalk_utils.py`中，您可以添加更多钉钉支持的消息类型，例如ActionCard、FeedCard等，以实现更丰富的交互体验。

### 7.3 集成数据库

如果您希望持久化用户的对话历史，可以集成数据库（如PostgreSQL或MySQL）。Railway和Render都提供了数据库服务，您可以在项目中添加数据库插件。

### 7.4 使用云存储

生成的PDF报告目前保存在服务器本地，如果希望用户能够下载，您需要将PDF上传到云存储服务（如阿里云OSS、AWS S3或腾讯云COS），并返回下载链接。

## 八、总结

通过本指南，您已经成功部署了一个功能完整的钉钉AI助手。这个助手可以与用户进行智能对话，生成专业报告，并定时推送AI资讯。您可以根据自己的需求进一步扩展和定制功能，打造一个真正属于您的AI助手。

如果在部署过程中遇到任何问题，欢迎在GitHub仓库中提交Issue，我们会尽快为您解答。祝您使用愉快！
